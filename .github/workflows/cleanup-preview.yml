name: Cleanup Preview Database

on:
  pull_request:
    types: [closed]

jobs:
  cleanup:
    name: Delete Branch Database
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Delete branch database
        env:
          TURSO_API_TOKEN: ${{ secrets.TURSO_API_TOKEN }}
          TURSO_ORG_NAME: ${{ secrets.TURSO_ORG_NAME }}
        run: |
          BRANCH_DB_NAME="itunes-spotify-pr-${{ github.event.pull_request.number }}"
          API_BASE="https://api.turso.tech/v1/organizations/${TURSO_ORG_NAME}"

          echo "Attempting to delete branch database: $BRANCH_DB_NAME"

          # Check if database exists
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${TURSO_API_TOKEN}" \
            "${API_BASE}/databases/${BRANCH_DB_NAME}")

          if [ "$HTTP_CODE" = "200" ]; then
            # Delete the database
            curl -X DELETE \
              -H "Authorization: Bearer ${TURSO_API_TOKEN}" \
              "${API_BASE}/databases/${BRANCH_DB_NAME}"
            echo "‚úÖ Branch database $BRANCH_DB_NAME deleted successfully"
          else
            echo "‚ÑπÔ∏è  Branch database $BRANCH_DB_NAME does not exist (may have been deleted already)"
          fi

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## üßπ Preview Cleanup Complete

              Branch database \`itunes-spotify-pr-${{ github.event.pull_request.number }}\` has been deleted.`
            })
